import React, { createContext, useContext } from 'react';
import { useQuery, useMutation, useQueryClient } from 'react-query';
import { fetchStudentData, updateStudentData, clearStudentCache } from '../api/student';

const StudentContext = createContext();

export const StudentProvider = ({ children }) => {
  console.log('ğŸ” DEBUG - StudentProvider tá»« StudentContext.jsx Ä‘Æ°á»£c khá»Ÿi táº¡o');
  const queryClient = useQueryClient();
  console.log('ğŸ” DEBUG - studentId trong StudentContext.jsx:', studentId); // Sáº½ hiá»ƒn thá»‹ undefined


  const { data: student, isLoading, error } = useQuery(
    'student',
    () => fetchStudentData(studentId),
    {
      staleTime: 5 * 60 * 1000, // 5 minutes
      cacheTime: 10 * 60 * 1000, // 10 minutes
      retry: 3,
      retryDelay: 1000,
    }
  );

  const updateStudentMutation = useMutation(
    (data) => updateStudentData(studentId, data),
    {
      onSuccess: (data) => {
        queryClient.setQueryData('student', data);
        message.success('Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng');
      },
      onError: (error) => {
        message.error('Cáº­p nháº­t thÃ´ng tin tháº¥t báº¡i');
      },
    }
  );

  const reloadStudentData = async () => {
    clearStudentCache(studentId);
    await queryClient.invalidateQueries('student');
  };

  const value = {
    student,
    loading: isLoading,
    error,
    updateStudent: updateStudentMutation.mutate,
    loadStudentData: reloadStudentData,
  };

  return (
    <StudentContext.Provider value={value}>
      {children}
    </StudentContext.Provider>
  );
};

export const useStudent = () => {
  console.log('ğŸ” DEBUG - useStudent Ä‘Æ°á»£c gá»i tá»« StudentContext.jsx');
  const context = useContext(StudentContext);
  if (!context) {
    throw new Error('useStudent must be used within a StudentProvider');
  }
  return context;
}; 